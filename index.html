<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    
    <title>yoyaku_system</title>
</head>
<body>
    <h1>マッチング</h1>
    <p>日付を選択してください</p>
    <form name="yearform">
      <select name="year">
        <option value="">-</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
        <option value="2026">2026</option>
        <option value="2027">2027</option>
        <option value="2028">2028</option>
        <option value="2029">2029</option>
        <option value="2030">2030</option>
      </select>
    </form>
    <form name="monthform">
      <select name="month">
        <option value="">-</option>
        <option value="01">1</option>
        <option value="02">2</option>
        <option value="03">3</option>
        <option value="04">4</option>
        <option value="05">5</option>
        <option value="06">6</option>
        <option value="07">7</option>
        <option value="08">8</option>
        <option value="09">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select>
    </form>

    <form name="dayform">
      <select name="day">
        <option value="">-</option>
        <option value="01">1</option>
        <option value="02">2</option>
        <option value="03">3</option>
        <option value="04">4</option>
        <option value="05">5</option>
        <option value="06">6</option>
        <option value="07">7</option>
        <option value="08">8</option>
        <option value="09">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        <option value="27">27</option>
        <option value="28">28</option>
        <option value="29">29</option>
        <option value="30">30</option>
        <option value="31">31</option>
      </select>
    </form>
    <button id = "index-btn">決定</button>

    <div class="matching_select">
      <form>
        <table>
          <tr id="user_table">
            <td>
              <table border="1">
                <tr id="user_checkbox">
                  <td>選択</td>          
                </tr>
                <tr id="user_name">
                  <td>利用者名</td>     
                </tr>
                <tr id="user_area">
                  <td>目的地</td> 
                </tr>  
                <tr id="user_start">
                  <td>開始時間</td>  
                </tr>
                <tr id="user_end">
                  <td>終了時間</td>       
                </tr>
              </table>
            </td>
            <td>
              <table border="1">
                <tr id="staff_checkbox">  
                  <td>選択</td>  
                </tr>
                <tr id="staff_name">
                  <td>スタッフ名</td> 
                </tr>
                <tr id="staff_area">
                  <td>勤務希望エリア</td> 
                </tr>  
                <tr id="staff_start">
                  <td>勤務開始時間</td> 
                </tr>
                <tr id="staff_end">    
                  <td>勤務終了時間</td>  
                </tr>
            </td>
          </tr>
        </table>
        <button type="button" class="submit_button">送信</button>
      </form>
    </div>
    <!-- <table>
      <tr id="user_table">
        <td>
          <table border="1">
            <tr id="user_checkbox">
              <td>選択</td>          
            </tr>
            <tr id="user_name">
              <td>利用者名</td>     
            </tr>
            <tr id="user_area">
              <td>目的地</td> 
            </tr>  
            <tr id="user_start">
              <td>開始時間</td>  
            </tr>
            <tr id="user_end">
              <td>終了時間</td>       
            </tr>
          </table>
        </td>
        <td>
          <table border="1">
            <tr id="staff_checkbox">  
              <td>選択</td>  
            </tr>
            <tr id="staff_name">
              <td>スタッフ名</td> 
            </tr>
            <tr id="staff_area">
              <td>勤務希望エリア</td> 
            </tr>  
            <tr id="staff_start">
              <td>勤務開始時間</td> 
            </tr>
            <tr id="staff_end">    
              <td>勤務終了時間</td>  
            </tr>
        </td>
      </tr>
    </table> -->
  
    <script>
      var btn = document.getElementById('index-btn');

      btn.addEventListener('click', ()=>{
        request_reservation_list();
      });

      // リスト取得
      const request_reservation_list = () => {
        // フォームから年情報取得
        const yearform = document.yearform.year;
        const yearnum = yearform.selectedIndex;
        const year = yearform.options[yearnum].value;
        // フォームから月情報取得
        const monthform = document.monthform.month;
        const monthnum = monthform.selectedIndex;
        const month = monthform.options[monthnum].value;

        const dayform = document.dayform.day;
        const daynum = dayform.selectedIndex;
        const day = dayform.options[daynum].value;

        let parameter = year + month + day;
        parameter = encodeURI(parameter);
        
        let request_url = "https://3fendtwomj.execute-api.ap-northeast-1.amazonaws.com/prod/testappapi?param1=";   
        request_url = request_url + parameter;

        fetch(request_url, { mode: "cors" })
        .then(response => response.json())
        .then(data => {
          // let output_label = document.getElementById("output_label");
          // output_label.innerText = data["body"][0]["area"]
          createUserTable(data);
          createStaffTable(data);
          console.log(data);
        });
      };
      
      // マッチング結果のID送信
      $(function () {
        $(document).on('click', '.matching_select .submit_button', function () {
          var matching = {};
          $(this).closest('form').find('[name=reservation]:checked').each(function () {
            var ids = $(this).val();
            console.log(ids[1]);
            matching["matching_id"] = ids;
          });
          
          parameter = encodeURI(matching);
          let request_url = "https://3fendtwomj.execute-api.ap-northeast-1.amazonaws.com/prod/matchingFunction?param1=";   
          request_url = request_url + parameter;
          
          fetch(request_url, {mode: 'cors'})
          .then(response => response.json())
          .then(data => {
            console.log(data);
          })
        });
      });

      function createUserTable(data) {
        user_checkbox = $('#user_checkbox');
        user_name = $('#user_name');
        user_area = $('#user_area');
        user_start = $('#user_start');
        user_end = $('#user_end');
        for(var i in data.body.user) {
            // <input type="checkbox" name="food" value="1">焼肉
            var user_checkbox_text = '<th><input type="checkbox" name="reservation" value=' + String(data.body.user[i].id) + '></th>';   
            var user_name_text = '<td>' + data.body.user[i].user_name + '</td>';
            var user_area_text = '<td>' + data.body.user[i].area + '</td>';
            var user_start_text = '<td>' + data.body.user[i].start + '</td>';
            var user_end_text = '<td>' + data.body.user[i].end + '</td>';

            $(user_checkbox).append(user_checkbox_text);
            $(user_name).append(user_name_text);
            $(user_area).append(user_area_text);
            $(user_start).append(user_start_text);
            $(user_end).append(user_end_text);
          }
      };

      function createStaffTable(data) {
        staff_checkbox = $('#staff_checkbox');
        staff_name = $('#staff_name');
        staff_area = $('#staff_area');
        staff_start = $('#staff_start');
        staff_end = $('#staff_end');
        for(var i in data.body.staff) {
            // <input type="checkbox" name="food" value="1">焼肉
            var staff_checkbox_text = '<th><input type="checkbox" name="reservation" value=' + String(data.body.staff[i].staff_id) + '></th>';   
            var staff_name_text = '<td>' + data.body.staff[i].staff_name + '</td>';
            var staff_area_text = '<td>' + data.body.staff[i].area + '</td>';
            var staff_start_text = '<td>' + data.body.staff[i].start + '</td>';
            var staff_end_text = '<td>' + data.body.staff[i].end + '</td>';

            $(staff_checkbox).append(staff_checkbox_text);
            $(staff_name).append(staff_name_text);
            $(staff_area).append(staff_area_text);
            $(staff_start).append(staff_start_text);
            $(staff_end).append(staff_end_text);
          }
      };


      
    </script>
</body>
</html>