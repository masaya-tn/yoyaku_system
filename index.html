<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>yoyaku_system</title>
</head>
<body>
    <h1>マッチング</h1>
    <p>日付を選択してください</p>
    <!-- カレンダー入力対応 -->
    <form name="yearform"> 
      <select name="year">
        <option value="">-</option>
        <option value="2020">2020年</option>
        <option value="2021">2021年</option>
        <option value="2022">2022年</option>
        <option value="2023">2023年</option>
        <option value="2024">2024年</option>
        <option value="2025">2025年</option>
        <option value="2026">2026年</option>
        <option value="2027">2027年</option>
        <option value="2028">2028年</option>
        <option value="2029">2029年</option>
        <option value="2030">2030年</option>
      </select>
    </form>
    <form name="monthform">
      <select name="month">
        <option value="">-</option>
        <option value="01">1月</option>
        <option value="02">2月</option>
        <option value="03">3月</option>
        <option value="04">4月</option>
        <option value="05">5月</option>
        <option value="06">6月</option>
        <option value="07">7月</option>
        <option value="08">8月</option>
        <option value="09">9月</option>
        <option value="10">10月</option>
        <option value="11">11月</option>
        <option value="12">12月</option>
      </select>
    </form>

    <form name="dayform">
      <select name="day">
        <option value="">-</option>
        <option value="01">1日日</option>
        <option value="02">2日</option>
        <option value="03">3日</option>
        <option value="04">4日</option>
        <option value="05">5日</option>
        <option value="06">6日</option>
        <option value="07">7日</option>
        <option value="08">8日</option>
        <option value="09">9日</option>
        <option value="10">10日</option>
        <option value="11">11日</option>
        <option value="12">12日</option>
        <option value="13">13日</option>
        <option value="14">14日</option>
        <option value="15">15日</option>
        <option value="16">16日</option>
        <option value="17">17日</option>
        <option value="18">18日</option>
        <option value="19">19日</option>
        <option value="20">20日</option>
        <option value="21">21日</option>
        <option value="22">22日</option>
        <option value="23">23日</option>
        <option value="24">24日</option>
        <option value="25">25日</option>
        <option value="26">26日</option>
        <option value="27">27日</option>
        <option value="28">28日</option>
        <option value="29">29日</option>
        <option value="30">30日</option>
        <option value="31">31日</option>
      </select>
    </form>
    <button id = "index-btn" class="btn btn-outline-success">確定</button>

    <div class="matching_select">
      <form>
        <table class="box-container">
          <tr id="user_table">
            <td>
              <table class="table user_table">
                <tr id="user_checkbox">
                  <td class="border border-secondary">選択</td>          
                </tr>
                <tr id="user_name">
                  <td class="border border-secondary">利用者名</td>     
                </tr>
                <tr id="user_area">
                  <td class="border border-secondary">目的地</td> 
                </tr>  
                <tr id="user_7h">
                  <td class="border border-secondary">7時</td>       
                </tr>
                <tr id="user_8h">
                  <td class="border border-secondary">8時</td>       
                </tr>
                <tr id="user_9h">
                  <td class="border border-secondary">9時</td>       
                </tr>
                <tr id="user_10h">
                  <td class="border border-secondary">10時</td>       
                </tr>
                <tr id="user_11h">
                  <td class="border border-secondary">11時</td>       
                </tr>
                <tr id="user_12h">
                  <td class="border border-secondary">12時</td>       
                </tr>
                <tr id="user_13h">
                  <td class="border border-secondary">13時</td>       
                </tr>
                <tr id="user_14h">
                  <td class="border border-secondary">14時</td>       
                </tr>
                <tr id="user_15h">
                  <td class="border border-secondary">15時</td>       
                </tr>
                <tr id="user_16h">
                  <td class="border border-secondary">16時</td>       
                </tr>
                <tr id="user_17h">
                  <td class="border border-secondary">17時</td>       
                </tr>
                <tr id="user_18h">
                  <td class="border border-secondary">18時</td>       
                </tr>
                <tr id="user_19h">
                  <td class="border border-secondary">19時</td>       
                </tr>
                <tr id="user_20h">
                  <td class="border border-secondary">20時</td>       
                </tr>
                <tr id="user_21h">
                  <td class="border border-secondary">21時</td>       
                </tr>
              </table>
            </td>
            <td>
              <table class="table staff_table">
                <tr id="staff_checkbox">  
                  <td class="border border-secondary">選択</td>  
                </tr>
                <tr id="staff_name">
                  <td class="border border-secondary">スタッフ名</td> 
                </tr>
                <tr id="staff_area">
                  <td class="border border-secondary">勤務希望エリア</td> 
                </tr>  
                <tr id="staff_7h">
                  <td class="border border-secondary">7時</td>       
                </tr>
                <tr id="staff_8h">
                  <td class="border border-secondary">8時</td>       
                </tr>
                <tr id="staff_9h">
                  <td class="border border-secondary">9時</td>       
                </tr>
                <tr id="staff_10h">
                  <td class="border border-secondary">10時</td>       
                </tr>
                <tr id="staff_11h">
                  <td class="border border-secondary">11時</td>       
                </tr>
                <tr id="staff_12h">
                  <td class="border border-secondary">12時</td>       
                </tr>
                <tr id="staff_13h">
                  <td class="border border-secondary">13時</td>       
                </tr>
                <tr id="staff_14h">
                  <td class="border border-secondary">14時</td>       
                </tr>
                <tr id="staff_15h">
                  <td class="border border-secondary">15時</td>       
                </tr>
                <tr id="staff_16h">
                  <td class="border border-secondary">16時</td>       
                </tr>
                <tr id="staff_17h">
                  <td class="border border-secondary">17時</td>       
                </tr>
                <tr id="staff_18h">
                  <td class="border border-secondary">18時</td>       
                </tr>
                <tr id="staff_19h">
                  <td class="border border-secondary">19時</td>       
                </tr>
                <tr id="staff_20h">
                  <td class="border border-secondary">20時</td>       
                </tr>
                <tr id="staff_21h">
                  <td class="border border-secondary">21時</td>       
                </tr>
              </table>
            </td>
          </tr>
        </table>
        <button type="button" class="submit_button display btn btn-outline-success">確定</button>
      </form>
    </div>
  
    <script>
      var btn = document.getElementById('index-btn');

      btn.addEventListener('click', ()=>{
        request_reservation_list();
      });

      // リスト取得
      const request_reservation_list = () => {
        // フォームから年情報取得
        const yearform = document.yearform.year;
        const yearnum = yearform.selectedIndex;
        const year = yearform.options[yearnum].value;
        // フォームから月情報取得
        const monthform = document.monthform.month;
        const monthnum = monthform.selectedIndex;
        const month = monthform.options[monthnum].value;

        const dayform = document.dayform.day;
        const daynum = dayform.selectedIndex;
        const day = dayform.options[daynum].value;

        let parameter = year + month + day;
        parameter = encodeURI(parameter);
        
        let request_url = "https://3fendtwomj.execute-api.ap-northeast-1.amazonaws.com/prod/testappapi?param1=";   
        request_url = request_url + parameter;

        fetch(request_url, { mode: "cors" })
        .then(response => response.json())
        .then(data => {
          // let output_label = document.getElementById("output_label");
          // output_label.innerText = data["body"][0]["area"]
          console.log(data);
          createUserTable(data);
          createStaffTable(data);
          
      })};
      
      // マッチング結果のID送信
      $(function () {
        $(document).on('click', '.matching_select .submit_button', function () {
          var ids = [];
          $(this).closest('form').find('[name=reservation]:checked').each(function () {
            ids.push($(this).val());
          });
          
          // staff_idにはスタッフの予約のIDが格納される
          let request_url = "https://3fendtwomj.execute-api.ap-northeast-1.amazonaws.com/prod/matchingFunction?";   
          request_url = request_url + 'yoyaku_id=' + ids[0] + '&staff_id=' + ids[1];
          
          fetch(request_url, {mode: 'cors'})
          .then(response => response.json())
          .then(data => {
            console.log(data)
            if (data.body[0] == 'マッチング成功しました'){
              window.alert('マッチングに成功しました');
              location.reload();
            }else if(data.body[0] == 'マッチング失敗しました'){
              window.alert('マッチングに失敗しました、時間が合わない組み合わせです')
            }
          })
        });
      });

      function createUserTable(data) {
        for(let i in data.body.user) {
            let start = extractDate(data.body.user[i].start);
            let end = extractDate(data.body.user[i].end);

            let user_checkbox_td = '<th class="border table-success border-secondary"><input type="checkbox" name="reservation" value=' + String(data.body.user[i].id) + '></th>';   
            let user_name_td = '<td class="border table-success border-secondary">' + data.body.user[i].user_name + '</td>';
            let user_area_td = '<td class="border table-success border-secondary">' + data.body.user[i].area + '</td>';
            let user_start_td = '<td class="border table-success border-secondary">' + start + '時</td>';
            let user_end_td = '<td class="border table-success border-secondary">' + end + '時</td>';
            let user_time_td;

            $('#user_checkbox').append(user_checkbox_td);
            $('#user_name').append(user_name_td);
            $('#user_area').append(user_area_td);
            $('#user_start').append(user_start_td);
            $('#user_end').append(user_end_td);

            // 希望時間帯のみ色を付ける
            for(let time = 7; time <= 21; time++) {
              if (time >= Number(start) && time <= Number(end)) {
                user_time_td = '<td class="border table-success border_secondary"></td>';
                $(`#user_${time}h`).append(user_time_td);
              } else {
                user_time_td = '<td class="border border-secondary"></td>';
                $(`#user_${time}h`).append(user_time_td);
              }
            };
          }
      };

      function createStaffTable(data) {
        for(let i in data.body.staff) {
            let start = extractDate(data.body.staff[i].start)
            let end = extractDate(data.body.staff[i].end)
            let staff_checkbox_td = '<th class="border table-info border-secondary"><input type="checkbox" name="reservation" value=' + String(data.body.staff[i].id) + '></th>';   
            let staff_name_td = '<td class="border table-info border-secondary">' + data.body.staff[i].staff_name + '</td>';
            let staff_area_td = '<td class="border table-info border-secondary">' + data.body.staff[i].area + '</td>';
            let staff_start_td = '<td class="border table-info border-secondary">' + start + '時</td>';
            let staff_end_td = '<td class="border table-info border-secondary">' + end + '時</td>';

            $('#staff_checkbox').append(staff_checkbox_td);
            $('#staff_name').append(staff_name_td);
            $('#staff_area').append(staff_area_td);
            $('#staff_start').append(staff_start_td);
            $('#staff_end').append(staff_end_td);

            // 希望時間帯のみ色を付ける
            for(let time = 7; time <= 21; time++) {
              if (time >= Number(start) && time <= Number(end)) {
                staff_time_td = '<td class="border table-info border-secondary"></td>';

                $(`#staff_${time}h`).append(staff_time_td);
              } else {
                staff_time_td = '<td class="border border-secondary"></td>';
                $(`#staff_${time}h`).append(staff_time_td);
              }
            };
          }
      };

      function extractDate(date) {
        var time = date.substr(8);
        return time
      }

      

      
    </script>
</body>
</html>