<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>yoyaku_system</title>
</head>
<body>
    <h1>マッチング</h1>
    <p>日付を選択してください</p>
    <form name="yearform">
      <select name="year">
        <option value="">-</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
        <option value="2026">2026</option>
        <option value="2027">2027</option>
        <option value="2028">2028</option>
        <option value="2029">2029</option>
        <option value="2030">2030</option>
      </select>
    </form>
    <form name="monthform">
      <select name="month">
        <option value="">-</option>
        <option value="01">1</option>
        <option value="02">2</option>
        <option value="03">3</option>
        <option value="04">4</option>
        <option value="05">5</option>
        <option value="06">6</option>
        <option value="07">7</option>
        <option value="08">8</option>
        <option value="09">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select>
    </form>

    <form name="dayform">
      <select name="day">
        <option value="">-</option>
        <option value="01">1</option>
        <option value="02">2</option>
        <option value="03">3</option>
        <option value="04">4</option>
        <option value="05">5</option>
        <option value="06">6</option>
        <option value="07">7</option>
        <option value="08">8</option>
        <option value="09">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        <option value="27">27</option>
        <option value="28">28</option>
        <option value="29">29</option>
        <option value="30">30</option>
        <option value="31">31</option>
      </select>
    </form>
    <button id = "index-btn">決定</button>
  
    
    <div class="matching-form">
      <form>
        <b>予約一覧</b>
        <ul id="user_list">
          <!-- ここに出力 -->
        </ul>
        <b>勤務希望一覧</b>
        <ul id="staff_list">
          <!-- ここに出力 -->
        </ul>
        <button type="button" class="submit_button">送信</button>
      </form>
    </div>
    
    <script>
      var btn = document.getElementById('index-btn');

      btn.addEventListener('click', ()=>{
        request_reservation_list();
      });

      // リスト取得
      const request_reservation_list = () => {
        // フォームから年情報取得
        const yearform = document.yearform.year;
        const yearnum = yearform.selectedIndex;
        const year = yearform.options[yearnum].value;
        // フォームから月情報取得
        const monthform = document.monthform.month;
        const monthnum = monthform.selectedIndex;
        const month = monthform.options[monthnum].value;

        const dayform = document.dayform.day;
        const daynum = dayform.selectedIndex;
        const day = dayform.options[daynum].value;

        let parameter = year + month + day;
        parameter = encodeURI(parameter);
        
        let request_url = "https://3fendtwomj.execute-api.ap-northeast-1.amazonaws.com/prod/testappapi?param1=";   
        request_url = request_url + parameter;

        fetch(request_url, { mode: "cors" })
        .then(response => response.json())
        .then(data => {
          let output_label = document.getElementById("output_label");
          // output_label.innerText = data["body"][0]["area"]
          console.log(data)
          user_target = $('#user_list');
          for(var i in data.body.user) {
            // <input type="checkbox" name="food" value="1">焼肉
            var content1 = '<input type="checkbox" name="reservation" value=' + String(data.body.user[i].id) + '>' + data.body.user[i].area + data.body.user[i].start ;   
            var text = content1;
            $(user_target).append(text);
          }

          staff_target = $('#staff_list')
          for(var i in data.body.user) {
            // <input type="checkbox" name="food" value="1">焼肉
            var content1 = '<input type="checkbox" name="reservation" value=' + String(data.body.staff[i].staff_id) + '>' + data.body.staff[i].area + data.body.staff[i].start ;   
            var text = content1;
            $(staff_target).append(text);
          }
        });
      };
      
      // マッチング対象のID送信
      $(function () {
        $(document).on('click', '.matching-form .submit_button', function () {
          var matching = {};
          $(this).closest('form').find('[name=reservation]:checked').each(function () {
            var ids = $(this).val();
            matching["matching_id"] = ids;
          });

        let request_url = "https://3fendtwomj.execute-api.ap-northeast-1.amazonaws.com/prod/matchingFunction";   
        
        fetch(request_url, {
          method: 'POST',
          mode: 'cors',
          body: JSON.stringify(matching)
        })
        .then(response => response.json())
        .then(data => {
          alert(data);
        })
        });
      });
      
    </script>
</body>
</html>